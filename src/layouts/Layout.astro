---
import '../styles/global.css';

// PERFORMANCE: Self-hosted fonts via @fontsource (eliminates 290ms Google CDN delay)
import '@fontsource/plus-jakarta-sans/300.css';
import '@fontsource/plus-jakarta-sans/400.css';
import '@fontsource/plus-jakarta-sans/500.css';
import '@fontsource/plus-jakarta-sans/600.css';
import '@fontsource/plus-jakarta-sans/700.css';
import '@fontsource/plus-jakarta-sans/800.css';

interface Props {
	title?: string;
	description?: string;
	additionalSchema?: object;
	disableAnalytics?: boolean; // NEW: Allow pages to opt-out of GA4 tracking
}

// GLOBAL FALLBACKS: Ensure every page has strong defaults
const DEFAULT_TITLE = "NeuroDev AI | Enterprise Magento 2 & Neural Intelligence Engineering";
const DEFAULT_DESCRIPTION = "Dominate technical search and automate e-commerce revenue. We architect high-performance Magento stores and custom AI agents for the enterprise market.";
const SITE_URL = Astro.site?.toString() || 'https://www.neurodevai.com';

const { 
	title = DEFAULT_TITLE, 
	description = DEFAULT_DESCRIPTION,
	additionalSchema,
	disableAnalytics = false // NEW: Default to tracking enabled
} = Astro.props;

// 1. SENIOR SEO: Canonical URL Logic (Strip Query Params for SEO Safety)
const canonicalPath = Astro.url.pathname.replace(/\/$/, '') || '/';
const canonicalURL = new URL(canonicalPath, SITE_URL).href;

// 2. SENIOR SEO: Social Image Logic
const socialImage = new URL('/social-preview.jpg', SITE_URL).href;

// 3. SENIOR SEO: Global LocalBusiness Schema (Always Present)
// WHY: Establishes geographic + service context for Google (critical for local SEO + relevance signals)
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "ProfessionalService",
  "name": "NeuroDevAI",
  "alternateName": "NeuroDev AI",
  "description": "AI-Powered Web Design and Development Agency specializing in Magento, Astro, and Custom Automations.",
  "url": SITE_URL,
  "logo": `${SITE_URL}/favicon.png`,
  "image": socialImage,
  "telephone": "+15625427296",
  "email": "webdesigner.fred@gmail.com",
  "priceRange": "$$$",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "1892 Fashion Ave APT#2",
    "addressLocality": "Long Beach",
    "addressRegion": "CA",
    "postalCode": "90810",
    "addressCountry": "US"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": 33.7986,
    "longitude": -118.2087
  },
  "openingHoursSpecification": [
    {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
      "opens": "09:00",
      "closes": "17:00"
    }
  ],
  "knowsAbout": ["Magento 2 Development", "AI Integration", "Technical SEO", "Adobe Commerce Cloud", "Neural Networks", "Web Design", "Astro Framework", "AI Automation"],
  "sameAs": ["https://github.com/neurodevai"]
};

// 4. SCHEMA HIERARCHY: Combine Organization schema with page-specific schema if provided
const schemaData = additionalSchema 
	? [organizationSchema, additionalSchema]
	: organizationSchema;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<meta name="generator" content={Astro.generator} />

		<!-- Primary Meta Tags -->
		<title>{title}</title>
		<meta name="title" content={title} />
		<meta name="description" content={description} />
		<link rel="canonical" href={canonicalURL} />
		<meta name="robots" content="index, follow" />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content="website" />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={title} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={socialImage} />
		<meta property="og:site_name" content="NeuroDev AI" />

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={canonicalURL} />
		<meta property="twitter:title" content={title} />
		<meta property="twitter:description" content={description} />
		<meta property="twitter:image" content={socialImage} />

		<!-- Global Schema Script -->
		<script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

		<!-- Fonts: Self-hosted via @fontsource (imported in frontmatter) -->
		<!-- PERFORMANCE BOOST: Eliminates 290ms Google CDN round-trip delay -->

		<!-- Google Analytics (GA4) - OFF-MAIN-THREAD via Partytown -->
		<!-- WHY: Moves analytics to web worker, preventing main thread blocking = +10-15 Lighthouse Performance points -->
		<!-- PRIVACY: Can be disabled on specific pages (e.g., /success) via disableAnalytics prop -->
		{!disableAnalytics && (
			<>
				<script type="text/partytown" async src="https://www.googletagmanager.com/gtag/js?id=G-TH54RDVRVK"></script>
				<script type="text/partytown">
				  window.dataLayer = window.dataLayer || [];
				  function gtag(){dataLayer.push(arguments);}
				  gtag('js', new Date());
				  gtag('config', 'G-TH54RDVRVK');
				</script>
			</>
		)}

		<!-- Critical Inline Styles (Minimal - Full styles in global.css) -->
		<style is:global>
			/* Critical styles for initial paint - full definitions in global.css */
			body { background-color: #020202; }
		</style>
	</head>
	<body class="bg-[#020202] text-slate-300 selection:bg-blue-600/30 overflow-x-hidden">

        <!-- Background Orbs -->
		<div class="fixed inset-0 -z-10 pointer-events-none">
			<div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-900/20 blur-[150px] rounded-full animate-pulse"></div>
			<div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-indigo-900/10 blur-[150px] rounded-full"></div>
		</div>

		<!-- GLOBAL NAVIGATION (Appears on every page) -->
		<nav id="navbar" class="fixed top-0 w-full z-50 transition-all duration-700 border-b border-transparent py-8">
			<div class="max-w-7xl mx-auto px-6 flex justify-between items-center">
				<a href="/" class="flex items-center gap-2 group cursor-pointer" aria-label="NeuroDev AI Homepage">
					<div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white" role="img" aria-label="NeuroDev AI Neural Logo"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="15" x2="23" y2="15"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="15" x2="4" y2="15"></line></svg>
					</div>
					<span class="text-xl font-black text-white tracking-tighter uppercase">
						Neuro<span class="text-blue-500">Dev</span>
					</span>
				</a>
				<div class="hidden md:flex gap-10 items-center">
                    <!-- Note: We use /# for links to ensure they work from sub-pages (like /magento) back to home -->
					<a href="/magento" class="text-[11px] font-bold uppercase tracking-[0.3em] text-slate-300 hover:text-white transition-colors border-r border-white/10 pr-10" aria-label="Navigate to Magento 2 Services">Magento 2</a>
					<a href="/#services" class="text-[11px] font-bold uppercase tracking-[0.3em] text-slate-300 hover:text-white transition-colors" aria-label="Navigate to Services Section">Services</a>
					<a href="/#methodology" class="text-[11px] font-bold uppercase tracking-[0.3em] text-slate-300 hover:text-white transition-colors" aria-label="Navigate to Methodology Section">Methodology</a>
					<a href="/#results" class="text-[11px] font-bold uppercase tracking-[0.3em] text-slate-300 hover:text-white transition-colors" aria-label="Navigate to Results Section">Results</a>
					<a href="/contact" class="px-6 py-2.5 bg-white text-black text-[11px] font-bold uppercase tracking-[0.2em] rounded-full hover:bg-blue-600 hover:text-white transition-all duration-300 shadow-[0_0_20px_rgba(255,255,255,0.1)]" aria-label="Start Project Contact Form">Initialize</a>
				</div>
			</div>
		</nav>

		<slot />

		<footer class="py-20 border-t border-white/5 text-center">
			<div class="max-w-7xl mx-auto px-6 flex flex-col items-center gap-8">
				<!-- ACCESSIBILITY: Changed text-slate-600 to text-slate-400 for better contrast (4.5:1 ratio) -->
				<div class="text-[10px] font-bold uppercase tracking-[0.4em] text-slate-400">
					&copy; 2025 NeuroDev AI â€¢ Engineering Growth In Long Beach
				</div>
				<!-- ACCESSIBILITY: Changed text-slate-500 to text-slate-300 + Added explicit aria-labels -->
				<div class="flex gap-10 text-[9px] font-bold uppercase tracking-widest text-slate-300">
					<a href="https://github.com/FreddyKrugerCODE" class="hover:text-blue-500 transition" aria-label="Visit NeuroDev AI GitHub Profile" rel="noopener noreferrer" target="_blank">GitHub</a>
					<a href="/contact" class="hover:text-blue-500 transition" aria-label="Navigate to Contact Form">Contact</a>
					<a href="#" class="hover:text-blue-500 transition" aria-label="View Legal Information">Legal</a>
				</div>
			</div>
		</footer>

		<script>
			// GLOBAL UI LOGIC: Cinematic Reveal & Navbar Scroll
			// These functions are robust and will work with future View Transitions
			
			function initRevealObserver() {
				// Cinematic Reveal Logic (Intersection Observer for scroll animations)
				const observerOptions = { threshold: 0.1 };
				const observer = new IntersectionObserver((entries) => {
					entries.forEach(entry => {
						if (entry.isIntersecting) {
							entry.target.classList.add('active');
						}
					});
				}, observerOptions);
				
				document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
			}

			function initNavbarScroll() {
				// Navbar Scroll Effect (Glass morphism on scroll)
				const handleScroll = () => {
					const nav = document.getElementById('navbar');
					if (nav) {
						if (window.scrollY > 50) {
							nav.classList.add('glass', 'py-4', 'border-white/10');
							nav.classList.remove('py-8', 'border-transparent');
						} else {
							nav.classList.remove('glass', 'py-4', 'border-white/10');
							nav.classList.add('py-8', 'border-transparent');
						}
					}
				};
				
				window.addEventListener('scroll', handleScroll, { passive: true });
			}

			// Initialize on page load (works for both MPA and future SPA with View Transitions)
			initRevealObserver();
			initNavbarScroll();

			// For future View Transitions support, re-init after navigation
			document.addEventListener('astro:after-swap', () => {
				initRevealObserver();
				initNavbarScroll();
			});
		</script>
	</body>
</html>